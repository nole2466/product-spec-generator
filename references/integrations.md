# 第三方串接規範

> 記錄所有外部服務的串接資訊，確保團隊對「我們用了什麼服務」有一致理解

---

## 為什麼需要第三方串接文件？

| 問題 | 解法 |
|-----|------|
| RD 不知道該用哪個服務 | 統一的服務清單 |
| 串接規格散落各處 | 集中管理，易於查找 |
| 服務異常時不知道找誰 | 記錄聯絡窗口和 SLA |
| 新人不熟悉串接細節 | 完整的串接文件 |
| 費用不透明 | 記錄計價方式 |

---

## 文件結構

```
knowledge/
└── integrations/                # 第三方串接
    ├── _index.md               # 服務總覽
    ├── payment/                # 金流服務
    │   ├── _index.md
    │   ├── stripe.md
    │   └── ecpay.md
    ├── logistics/              # 物流服務
    │   ├── _index.md
    │   └── sf-express.md
    ├── notification/           # 通知服務
    │   ├── _index.md
    │   ├── firebase-fcm.md
    │   └── twilio.md
    ├── storage/                # 儲存服務
    │   ├── _index.md
    │   └── aws-s3.md
    ├── auth/                   # 身份驗證
    │   ├── _index.md
    │   └── google-oauth.md
    └── analytics/              # 分析服務
        ├── _index.md
        └── google-analytics.md
```

---

## 服務總覽（_index.md）

快速查找所有使用中的第三方服務。

### 範本

```markdown
# 第三方服務總覽

## 服務清單

| 類別 | 服務 | 用途 | 環境 | 狀態 |
|-----|------|------|------|:----:|
| 金流 | Stripe | 信用卡付款 | Prod | ✅ |
| 金流 | 綠界 ECPay | 超商付款 | Prod | ✅ |
| 物流 | 順豐 | 宅配 | Prod | ✅ |
| 通知 | Firebase FCM | App 推播 | Prod | ✅ |
| 通知 | Twilio | 簡訊 OTP | Prod | ✅ |
| 儲存 | AWS S3 | 檔案儲存 | Prod | ✅ |
| 登入 | Google OAuth | 第三方登入 | Prod | ✅ |
| 分析 | Google Analytics | 用戶分析 | Prod | ✅ |
| 地圖 | Google Maps | 地址輸入 | Prod | ✅ |
| AI | OpenAI | 智慧推薦 | Beta | 🧪 |

**狀態說明**：
- ✅ 正式使用
- 🧪 測試中
- ⚠️ 維護中
- ❌ 已棄用

## 帳號管理

| 服務 | 帳號管理者 | Dashboard |
|-----|----------|-----------|
| Stripe | @finance | [連結] |
| AWS | @devops | [連結] |
| Firebase | @backend | [連結] |

## 費用概覽

| 服務 | 計價方式 | 月估費用 | 負責人 |
|-----|---------|---------|-------|
| Stripe | 2.9% + 30¢/筆 | ~$5,000 | @finance |
| AWS S3 | $0.023/GB | ~$200 | @devops |
| Twilio | $0.05/則 | ~$500 | @backend |
```

---

## 服務文件撰寫原則

每個第三方服務都應該記錄：

1. **基本資訊**：服務用途、官方文件
2. **串接資訊**：API、SDK、環境變數
3. **使用限制**：Rate Limit、配額
4. **費用**：計價方式、預估費用
5. **異常處理**：錯誤碼、降級方案
6. **聯絡資訊**：技術支援、SLA

---

## 服務文件範本

### 完整範本

```markdown
# {服務名稱} 串接文件

## 基本資訊

| 項目 | 說明 |
|-----|------|
| 服務名稱 | {名稱} |
| 用途 | {我們用來做什麼} |
| 官方文件 | {連結} |
| Dashboard | {連結} |
| 串接日期 | {日期} |
| 負責人 | @{username} |

## 環境設定

### 環境變數

| 變數名稱 | 說明 | 範例 |
|---------|------|------|
| `{SERVICE}_API_KEY` | API 金鑰 | `sk_live_xxx` |
| `{SERVICE}_SECRET` | 密鑰 | `whsec_xxx` |
| `{SERVICE}_WEBHOOK_URL` | Webhook URL | `https://...` |

### 環境區分

| 環境 | 用途 | 備註 |
|-----|------|------|
| Sandbox | 開發測試 | 測試用金鑰 |
| Production | 正式環境 | 正式金鑰 |

## API 串接

### Base URL

| 環境 | URL |
|-----|-----|
| Sandbox | `https://api.sandbox.example.com` |
| Production | `https://api.example.com` |

### 認證方式

{說明如何認證}

### 常用 API

| API | 用途 | 文件 |
|-----|------|------|
| POST /orders | 建立訂單 | [連結] |
| GET /orders/{id} | 查詢訂單 | [連結] |

### 範例程式碼

{提供串接範例}

## Webhook

### 設定方式

{說明如何設定 Webhook}

### 事件類型

| 事件 | 說明 | 處理方式 |
|-----|------|---------|
| `order.completed` | 訂單完成 | 更新訂單狀態 |
| `payment.failed` | 付款失敗 | 通知用戶 |

### 驗證方式

{說明如何驗證 Webhook 真實性}

## 使用限制

### Rate Limit

| 項目 | 限制 | 超過時 |
|-----|------|-------|
| API 呼叫 | 100 次/分鐘 | 429 錯誤 |
| Webhook | 無限制 | - |

### 配額

| 項目 | 限制 | 費用 |
|-----|------|------|
| 每月請求 | 10,000 次免費 | 超過 $0.01/次 |

## 費用

### 計價方式

| 項目 | 費用 |
|-----|------|
| 基本費 | $XX/月 |
| 交易費 | X%/筆 |

### 預估月費

{根據使用量估算}

## 錯誤處理

### 常見錯誤碼

| 錯誤碼 | 說明 | 處理方式 |
|-------|------|---------|
| 400 | 參數錯誤 | 檢查請求參數 |
| 401 | 認證失敗 | 檢查 API Key |
| 429 | 超過限制 | 等待後重試 |
| 500 | 服務異常 | 使用降級方案 |

### 降級方案

當服務不可用時：

{說明替代方案}

## 測試

### 測試帳號

| 項目 | 值 |
|-----|---|
| 測試卡號 | 4242 4242 4242 4242 |
| 到期日 | 任意未來日期 |
| CVC | 任意 3 碼 |

### 測試情境

| 情境 | 測試方式 |
|-----|---------|
| 成功 | 使用測試卡號 |
| 失敗 | 使用 4000 0000 0000 0002 |

## 維護資訊

### 技術支援

| 管道 | 資訊 |
|-----|------|
| Email | support@example.com |
| 文件 | https://docs.example.com |
| 狀態頁 | https://status.example.com |

### SLA

| 項目 | 保證 |
|-----|------|
| 可用性 | 99.9% |
| 回應時間 | < 200ms |

## 變更紀錄

| 日期 | 變更內容 | 負責人 |
|-----|---------|-------|
| 2024-01-01 | 初次串接 | @backend |
| 2024-03-15 | 升級 API v2 | @backend |
```

---

## 常見服務類別

### 金流服務

| 服務 | 說明 | 適用場景 |
|-----|------|---------|
| Stripe | 國際信用卡 | 跨境電商 |
| 綠界 ECPay | 台灣在地金流 | 台灣電商 |
| LINE Pay | 行動支付 | 台灣/日本 |
| PayPal | 國際支付 | 跨境 B2C |
| TapPay | 台灣信用卡 | 台灣 App |

### 物流服務

| 服務 | 說明 | 適用場景 |
|-----|------|---------|
| 綠界物流 | 超商取貨 | 台灣 C2C |
| 黑貓宅急便 | 宅配 | 台灣 B2C |
| 順豐 | 跨境物流 | 兩岸 |
| DHL | 國際快遞 | 跨境 |

### 通知服務

| 服務 | 說明 | 適用場景 |
|-----|------|---------|
| Firebase FCM | App 推播 | iOS/Android |
| Twilio | 簡訊 | OTP、通知 |
| SendGrid | Email | 行銷、交易信 |
| LINE Notify | LINE 通知 | 台灣用戶 |

### 身份驗證

| 服務 | 說明 | 適用場景 |
|-----|------|---------|
| Google OAuth | Google 登入 | 通用 |
| Apple Sign In | Apple 登入 | iOS App |
| LINE Login | LINE 登入 | 台灣/日本 |
| Auth0 | 身份管理 | 企業級 |

### 儲存服務

| 服務 | 說明 | 適用場景 |
|-----|------|---------|
| AWS S3 | 物件儲存 | 檔案、圖片 |
| Cloudflare R2 | CDN 儲存 | 靜態資源 |
| GCP Cloud Storage | 物件儲存 | GCP 生態系 |

### 其他常見服務

| 類別 | 服務 | 用途 |
|-----|------|------|
| 地圖 | Google Maps | 地址、定位 |
| 搜尋 | Algolia | 全文搜尋 |
| 分析 | Mixpanel | 用戶行為分析 |
| 監控 | Sentry | 錯誤追蹤 |
| AI | OpenAI | 智慧功能 |

---

## 在 spec 中引用

```markdown
## 第三方服務

本功能使用以下第三方服務：

| 服務 | 用途 | 文件 |
|-----|------|------|
| Stripe | 信用卡付款 | [→ integrations/payment/stripe.md] |
| Firebase FCM | 推播通知 | [→ integrations/notification/firebase-fcm.md] |

### 串接注意事項

- Stripe 測試環境使用 `sk_test_` 開頭的金鑰
- 付款成功後需等待 Webhook 確認
```

---

## AI 協作指南

### 讓 AI 幫你撰寫串接文件

**Prompt 範本**：

```
請幫我撰寫 {服務名稱} 的串接文件。

已知資訊：
- 用途：{我們用來做什麼}
- 官方文件：{連結}

請依照以下結構產出：
1. 基本資訊
2. 環境設定（環境變數）
3. API 串接（常用 API、範例程式碼）
4. 錯誤處理（常見錯誤碼）
5. 測試（測試帳號、測試情境）
```

### 讓 AI 幫你評估服務

**Prompt 範本**：

```
我需要 {功能類型} 的第三方服務，請幫我比較：

需求：
- {需求 1}
- {需求 2}

請比較以下服務：
1. 功能是否滿足需求
2. 費用比較
3. 串接難度
4. 優缺點分析
5. 推薦選擇
```

---

## 擴充指南

### 新增服務類別

如果現有類別不夠用，可以新增：

```
knowledge/integrations/
├── {new-category}/
│   ├── _index.md      # 類別總覽
│   └── {service}.md   # 服務文件
```

### 服務文件命名

- 使用小寫
- 用連字號分隔
- 與官方名稱對應

範例：
- `google-maps.md`
- `aws-s3.md`
- `firebase-fcm.md`

### 維護建議

| 頻率 | 項目 |
|-----|------|
| 每次串接 | 新增/更新服務文件 |
| 每季 | 檢查費用和 SLA |
| 服務變更時 | 更新 API 版本和異動 |
| 異常發生時 | 補充錯誤處理方式 |
